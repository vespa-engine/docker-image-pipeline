# Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.
shared:
  annotations:
    screwdriver.cd/restrictPR: fork

jobs:
  publish:
    requires: [~pr, ~commit]
    image: docker.io/almalinux:9
    secrets:
      - DOCKER_HUB_DEPLOY_KEY

    annotations:
      screwdriver.cd/cpu: HIGH
      screwdriver.cd/ram: HIGH
      screwdriver.cd/disk: HIGH
      screwdriver.cd/timeout: 30

    environment:
      USER_SHELL_BIN: bash
      CONTAINER_IMAGE: "docker.io/vespaengine/vespa-pipeline"
      CONTAINER_TAG: "latest"

    steps:
      - inspect: |
          set -x
          env | grep -v TOKEN
          cat /proc/cpuinfo
          cat /proc/meminfo
          df -h
          uname -a

      - install-deps: |
          dnf install -y podman podman-docker buildah skopeo
          # Default to host network
          sed -i 's,.*netns.*=.*private.*,netns = "host",' /usr/share/containers/containers.conf
          # To avoid warning messages from podman-docker
          touch /etc/containers/nodocker
          # Install the multi-arch support
          podman run --rm --cap-add SYS_ADMIN docker.io/multiarch/qemu-user-static --reset -p yes
      - build: |
          buildah bud \
            --file Dockerfile \
            --jobs 2  \
            --label "source_repo=$GIT_URL" \
            --label "source_ref=$GIT_COMMIT" \
            --label "build_url=$SD_BUILD_URL" \
            --layers=false \
            --manifest "$CONTAINER_IMAGE:$CONTAINER_TAG" \
            --platform linux/amd64,linux/arm64

          buildah manifest inspect "$CONTAINER_IMAGE:$CONTAINER_TAG"

      - publish: |
          if [[ -z $SD_PULL_REQUEST ]]; then
            set +x
            buildah login --username aressem --password "$DOCKER_HUB_DEPLOY_KEY" docker.io
            set -x

            buildah manifest push --all --format v2s2 "$CONTAINER_IMAGE:$CONTAINER_TAG" "docker://$CONTAINER_IMAGE:$CONTAINER_TAG"
          fi

      - teardown-inspect: |
          docker image ls
          df -h
